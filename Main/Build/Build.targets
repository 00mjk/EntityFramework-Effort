<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0" DefaultTargets="default">
    <PropertyGroup>
        <BaseDir>$(MSBuildProjectDirectory)\..</BaseDir>
        <TempDir>$(MSBuildProjectDirectory)\_temp</TempDir>
        <PackageDir>$(MSBuildProjectDirectory)\Packages</PackageDir>
        <SolutionDir>$(BaseDir)\Source</SolutionDir>
        <SolutionFile>$(SolutionDir)\Effort.sln</SolutionFile>
        <EffortNugetPackageDir>EffortNuget</EffortNugetPackageDir>
        <EffortZipPackageDir>EffortZip</EffortZipPackageDir>
        
        <RunTests Condition="$(RunTests) == ''">False</RunTests>
    </PropertyGroup>
  
    <ItemGroup>
        <CompileConfig Include="Release(pre-ef6,net40)">
            <NugetDir>lib\net40</NugetDir>
            <ZipDir>.NET 4.0\Entity Framework 4-5</ZipDir>
        </CompileConfig>
        <CompileConfig Include="Release(pre-ef6,net45)">
            <NugetDir>lib\net45</NugetDir>
            <ZipDir>.NET 4.5\Entity Framework 4-5</ZipDir>
        </CompileConfig>
        <CompileConfig Include="Release(ef6,net40)">
            <NugetDir></NugetDir>
            <ZipDir>.NET 4.0\Entity Framework 6</ZipDir>
        </CompileConfig>
        <CompileConfig Include="Release(ef6,net45)">
            <NugetDir></NugetDir>
            <ZipDir>.NET 4.5\Entity Framework 6</ZipDir>
        </CompileConfig>
    </ItemGroup>
 
    <Target Name="default" DependsOnTargets="Initialize; Compile; Collect; NugetPackage; ZipPackage; Cleanup" />
    
    <Target Name="Initialize">
        <RemoveDir Directories="$(TempDir)" />
        <RemoveDir Directories="$(PackageDir)" />
        <MakeDir Directories="$(PackageDir)" />
    </Target>
 
    <Target Name="Compile" Outputs="%(CompileConfig.Identity)">
        <Message Text="Build task with &quot;%(CompileConfig.Identity)&quot; configuration" />
        <RemoveDir Directories="$(SolutionDir)\Effort\bin\%(CompileConfig.Identity)\" />
        <MSBuild Projects="$(SolutionFile)" Properties="Configuration=%(CompileConfig.Identity);Platform=Any CPU"  />
    </Target>
 
    <Target Name="Collect" Outputs="%(CompileConfig.Identity)">
        <PropertyGroup>
            <SourceDir>$(SolutionDir)\Effort\bin\%(CompileConfig.Identity)</SourceDir>
            <DestinationDirNuget>$(TempDir)\$(EffortNugetPackageDir)\%(CompileConfig.NugetDir)</DestinationDirNuget>
            <DestinationDirZip>$(TempDir)\$(EffortZipPackageDir)\%(CompileConfig.ZipDir)</DestinationDirZip>
        </PropertyGroup>
        <ItemGroup>
            <SourceFilesCommon Include="$(SourceDir)\Effort.dll"/>
            <SourceFilesCommon Include="$(SourceDir)\Effort.xml"/>
            <SourceFilesZip Include="$(SourceDir)\NMemory.dll"/>
        </ItemGroup>
        <Copy 
            Condition="%(CompileConfig.NugetDir) != ''"
            SourceFiles="@(SourceFilesCommon)" 
            DestinationFolder="$(DestinationDirNuget)" />
        <Copy 
            Condition="%(CompileConfig.ZipDir) != ''"
            SourceFiles="@(SourceFilesCommon)" 
            DestinationFolder="$(DestinationDirZip)" />
        <Copy 
            Condition="%(CompileConfig.ZipDir) != ''"
            SourceFiles="@(SourceFilesZip)" 
            DestinationFolder="$(DestinationDirZip)" />
    </Target>
  
    <Target Name="NugetPackage">
        <Copy 
            SourceFiles="$(MSBuildProjectDirectory)\Effort.nuspec" 
            DestinationFolder="$(TempDir)\$(EffortNugetPackageDir)" />

        <Exec 
            WorkingDirectory="$(TempDir)\$(EffortNugetPackageDir)" 
            Command="$(SolutionDir)\.nuget\nuget.exe pack $(TempDir)\$(EffortNugetPackageDir)\Effort.nuspec" />
            
        <ItemGroup>
            <NugetPackage Include="$(TempDir)\$(EffortNugetPackageDir)\*.nupkg"/>
        </ItemGroup>
        <Message Text="@(NugetPackage)" Importance="High" />
        <Move 
            SourceFiles="@(NugetPackage)"
            DestinationFolder="$(PackageDir)" />
    </Target>
    
    <Target Name="ZipPackage">
        <CreateZip
            InputDirectory="$(TempDir)\$(EffortZipPackageDir)"
            OutputFile="$(PackageDir)\Library.zip" />
    </Target>
    
    <Target Name="Cleanup">
        <RemoveDir Directories="$(TempDir)" />
    </Target>
    
    <UsingTask TaskName="CreateZip" 
        TaskFactory="CodeTaskFactory" 
        AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
        <ParameterGroup>
            <InputDirectory ParameterType="System.String" Required="true" />
            <OutputFile ParameterType="System.String" Required="true" />
        </ParameterGroup>
        <Task>
            <Reference Include="System.Core" />
            <Reference Include="System.IO.Compression.FileSystem" />
            <Using Namespace="System" />
            <Using Namespace="System.IO" />
            <Using Namespace="System.IO.Compression" />
            <Using Namespace="Microsoft.Build.Framework" />
            <Using Namespace="Microsoft.Build.Utilities" />
            <Code Type="Fragment" Language="cs">
            <![CDATA[
                try {
                    InputDirectory = Path.GetFullPath(InputDirectory);
                    OutputFile = Path.GetFullPath(OutputFile);
                    
                    ZipFile.CreateFromDirectory(InputDirectory, OutputFile);
                    
                    return true;
                }
                catch (Exception ex) {
                    Log.LogErrorFromException(ex);
                    return false;
                }
            ]]>
            </Code>
        </Task>
    </UsingTask>
</Project>